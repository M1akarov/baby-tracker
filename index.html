<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Baby Tracker</title>
<style>
  :root{
    --bg:#f5f6f7;
    --card:#ffffff;
    --muted:#7b7f86;
    --text:#0b0b0c;
    --accent:#007aff;
    --accent-2:#34c759;
    --danger:#ff3b30;
    --radius:14px;
    --shadow: 0 10px 30px rgba(15,15,15,0.06);
  }
  *{box-sizing:border-box}
  body{
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
    background: linear-gradient(180deg, #fbfcfd, #f2f4f6);
    margin:0; color:var(--text); -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:1000px; margin:22px auto; padding:18px;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{font-size:20px;margin:0}
  .sub{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width:880px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; border:1px solid rgba(15,15,15,0.04)}
  .section-title{font-weight:700;font-size:14px;margin:0 0 10px}
  .controls{display:flex;flex-wrap:wrap;gap:10px}
  button{
    border:0;padding:12px 14px;border-radius:12px;font-weight:600;cursor:pointer;
    background:#f2f4f7;color:var(--text);border:1px solid rgba(15,15,15,0.04);
    display:inline-flex;align-items:center;gap:8px;
  }
  button:active{transform:translateY(1px)}
  .btn-primary{background:linear-gradient(180deg,#0b84ff,#007aff);color:#fff}
  .btn-green{background:linear-gradient(180deg,#39d26a,#17c04a);color:#fff}
  .btn-danger{background:linear-gradient(180deg,#ff6b6b,#ff3b30);color:#fff}
  .btn-ghost{background:transparent;border:1px solid rgba(15,15,15,0.03)}
  .status-row{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.04);font-size:13px}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .kpi{background:rgba(10,10,10,0.02);padding:10px;border-radius:10px;font-size:13px}
  .kpi .val{font-weight:700;font-size:16px;margin-top:6px}

  /* Timeline */
  .timeline{margin-top:16px}
  .day{margin-top:12px}
  .day h3{font-size:12px;color:var(--muted);text-transform:uppercase;margin:0 0 8px}
  .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfbfc);border:1px solid rgba(15,15,15,0.03);margin-bottom:8px}
  .left{display:flex;gap:12px;align-items:center}
  .ico{width:36px;height:36px;border-radius:10px;background:rgba(0,0,0,0.03);display:flex;align-items:center;justify-content:center;font-size:18px}
  .meta{display:flex;flex-direction:column}
  .meta .title{font-weight:700}
  .meta .sub{color:var(--muted);font-size:13px;margin-top:4px}
  .right{display:flex;gap:8px;align-items:center}
  .tiny{font-size:12px;color:var(--muted)}

  .trash{background:transparent;border:0;color:var(--danger);padding:6px 8px;border-radius:8px;cursor:pointer}
  .active-dot{width:10px;height:10px;border-radius:50%;background:var(--accent-2);box-shadow:0 0 0 6px rgba(52,199,89,0.12);margin-right:8px}

  /* toast */
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:opacity .16s}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Baby Tracker</h1>
        <!-- <div class="sub">–°–æ–Ω ¬∑ –ü—Ä–æ–≥—É–ª–∫–∞ ¬∑ –ü–æ–¥–≥—É–∑–Ω–∏–∫</div> -->
      </div>
      <!-- <div class="tiny">–î–∞–Ω–Ω—ã–µ –≤ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ*</div> -->
    </header>

    <div class="grid">
      <!-- Left column: Sleep + Feeding session -->
      <section class="card" aria-labelledby="sleep-title">
        <h2 id="sleep-title" class="section-title">–°–æ–Ω</h2>

        <div class="controls">
          <button id="sleepStart" class="btn-primary">–°—Ç–∞—Ä—Ç —Å–Ω–∞</button>
          <button id="sleepStop" class="btn-ghost">–°—Ç–æ–ø —Å–Ω–∞</button>
          <div style="flex:1"></div>
          <div id="sleepIndicator" class="badge">–°–µ–π—á–∞—Å: –Ω–µ —Å–ø–∏—Ç</div>
        </div>

        <div class="status-row">
          <div class="kpis" style="flex:1">
            <div class="kpi"><div class="tiny">–°–µ–≥–æ–¥–Ω—è</div><div class="val" id="sleepToday">0:00</div></div>
            <div class="kpi"><div class="tiny">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–µ—Å—Å–∏—è</div><div class="val" id="sleepLast">‚Äî</div></div>
            <div class="kpi"><div class="tiny">–¢–µ–∫—É—â–∞—è</div><div class="val" id="sleepCurrent">‚Äî</div></div>
          </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid rgba(0,0,0,0.04)">

        <h3 class="section-title">–ü—Ä–æ–≥—É–ª–∫–∞</h3>
        <div class="controls">
          <button id="feedSessionStart" class="btn-primary">–°—Ç–∞—Ä—Ç</button>
          <button id="feedSessionStop" class="btn-ghost">–§–∏–Ω–∏—à</button>
          <div style="flex:1"></div>
          <div id="feedSessionIndicator" class="badge">–°–µ–π—á–∞—Å: –Ω–µ –≤ –ø—Ä–æ–≥—É–ª–∫–∏</div>
        </div>

        <div style="margin-top:10px" class="kpis">
          <div class="kpi"><div class="tiny">–°–µ—Å—Å–∏–π —Å–µ–≥–æ–¥–Ω—è</div><div class="val" id="feedSessCount">0</div></div>
          <div class="kpi"><div class="tiny">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–µ—Å—Å–∏—è</div><div class="val" id="feedSessLast">‚Äî</div></div>
          <div class="kpi"><div class="tiny">–¢–µ–∫—É—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div><div class="val" id="feedSessCurrent">‚Äî</div></div>
        </div>
      </section>

      <!-- Right column: quick events -->
      <section class="card" aria-labelledby="quick-title">
        <h2 id="quick-title" class="section-title">–í–∞–∂–Ω—ã–µ –æ—Ç–º–µ—Ç–∫–∏</h2>
        <div class="controls" style="margin-bottom:12px">
          <button id="markFeed" class="btn-primary">üçº –ö–æ—Ä–º–ª–µ–Ω–∏–µ + </button>
          <button id="markDiaper" class="btn-green">üë∂üèª –ü–æ–¥–≥—É–∑–Ω–∏–∫ + </button>
          <button id="clearAll" class="btn-danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="tiny">–° –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ—Ä–º–ª–µ–Ω–∏—è</div><div class="val" id="sinceFeed">‚Äî</div></div>
          <div class="kpi"><div class="tiny">–° –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–º–µ–Ω—ã</div><div class="val" id="sinceDiaper">‚Äî</div></div>
          <div class="kpi"><div class="tiny">–°–µ–π—á–∞—Å</div><div class="val" id="nowTime">‚Äî</div></div>
        </div>
      </section>
    </div>

    <!-- Timeline -->
    <section class="card timeline" aria-labelledby="tl-title" style="margin-top:16px">
      <h2 id="tl-title" class="section-title">–õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π</h2>
      <div id="timeline"></div>
    </section>
  </div>

  <div id="toast"></div>

<script>
(() => {
  // ----- state shape -----
  // state.items: array of events/sessions ordered by time desc
  // item = {
  //   id: string,
  //   type: 'sleep'|'feed'|'diaper'|'feed_session',
  //   time?: number,           // for instant events
  //   start?: number, end?: number // for sessions
  // }
  const KEY = 'baby-tracker-v3';
  let state = { items: [] };

  // running sessions
  let sleepRunning = null;       // timestamp start or null
  let feedSessionRunning = null; // timestamp start or null
  let tickTimer = null;

  // DOM
  const el = s => document.querySelector(s);
  const $sleepStart = el('#sleepStart'), $sleepStop = el('#sleepStop'), $sleepIndicator = el('#sleepIndicator');
  const $sleepToday = el('#sleepToday'), $sleepLast = el('#sleepLast'), $sleepCurrent = el('#sleepCurrent');
  const $feedSessionStart = el('#feedSessionStart'), $feedSessionStop = el('#feedSessionStop'), $feedSessIndicator = el('#feedSessionIndicator');
  const $feedSessCount = el('#feedSessCount'), $feedSessLast = el('#feedSessLast'), $feedSessCurrent = el('#feedSessCurrent');
  const $markFeed = el('#markFeed'), $markDiaper = el('#markDiaper'), $clearAll = el('#clearAll');
  const $sinceFeed = el('#sinceFeed'), $sinceDiaper = el('#sinceDiaper'), $nowTime = el('#nowTime');
  const $timeline = el('#timeline');
  const $toast = el('#toast');

  // helpers
  const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,8);
  const fmtTime = t => {
    const d = new Date(t);
    return d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
  };
  const fmtDateKey = t => new Date(t).toISOString().slice(0,10);
  const fmtDateHuman = t => {
    const d = new Date(t);
    const key = fmtDateKey(t);
    const today = fmtDateKey(Date.now());
    const yesterday = fmtDateKey(Date.now() - 24*3600*1000);
    if (key === today) return '–°–µ–≥–æ–¥–Ω—è';
    if (key === yesterday) return '–í—á–µ—Ä–∞';
    return d.toLocaleDateString('ru-RU',{weekday:'short', day:'2-digit', month:'short'});
  };
  function fmtDuration(ms){
    if(ms == null || isNaN(ms)) return '‚Äî';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s % 3600)/60);
    const sec = s % 60;
    if(h>0) return `${h}—á ${m}–º`;
    return `${m}–º ${sec}s`;
  }

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(raw) state = JSON.parse(raw);
      else state = { items: [] };
    }catch(e){ state = { items: [] }; }
  }
  function save(){
    try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){ console.warn('Save failed',e); }
  }

  // add instant event
  function addInstant(type){
    const now = Date.now();
    state.items.unshift({ id: uid(), type, time: now });
    save(); render();
    toast('–û—Ç–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
  }

  // add session record
  function pushSession(type, start, end){
    state.items.unshift({ id: uid(), type, start, end });
    save(); render();
  }

  // delete
  function deleteItem(id){
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) return;
    state.items = state.items.filter(i=>i.id!==id);
    save(); render();
  }

  // start/stop for sleep
  function startSleep(){
    if(sleepRunning){ toast('–°–æ–Ω —É–∂–µ –∏–¥—ë—Ç'); return; }
    sleepRunning = Date.now();
    updateActiveUI();
    toast('–°–æ–Ω –Ω–∞—á–∞—Ç');
  }
  function stopSleep(){
    if(!sleepRunning){ toast('–°–æ–Ω –Ω–µ –∑–∞–ø—É—â–µ–Ω'); return; }
    const start = sleepRunning; const end = Date.now();
    const dur = end - start;
    // –∑–∞—â–∏—Ç–∞: –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ–Ω—å—à–µ 5 —Å–µ–∫—É–Ω–¥
    if(dur < 5000){ sleepRunning = null; updateActiveUI(); toast('–°–µ—Å—Å–∏—è —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è ‚Äî –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); return; }
    pushSession('sleep', start, end);
    sleepRunning = null;
    updateActiveUI();
    toast('–°–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  }

  // feeding session start/stop
  function startFeedSession(){
    if(feedSessionRunning){ toast('–ü—Ä–æ–≥—É–ª–∫–∞ —É–∂–µ –∏–¥—ë—Ç'); return; }
    feedSessionRunning = Date.now();
    updateActiveUI();
    toast('–°–µ—Å—Å–∏—è –ø—Ä–æ–≥—É–ª–∫–∏ –Ω–∞—á–∞—Ç–∞');
  }
  function stopFeedSession(){
    if(!feedSessionRunning){ toast('–°–µ—Å—Å–∏—è –ø—Ä–æ–≥—É–ª–∫–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞'); return; }
    const start = feedSessionRunning; const end = Date.now();
    const dur = end - start;
    if(dur < 3000){ feedSessionRunning = null; updateActiveUI(); toast('–ö–æ—Ä–æ—Ç–∫–∞—è —Å–µ—Å—Å–∏—è ‚Äî –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞'); return; }
    pushSession('feed_session', start, end);
    feedSessionRunning = null;
    updateActiveUI();
    toast('–°–µ—Å—Å–∏—è –ø—Ä–æ–≥—É–ª–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
  }

  // metrics
  function sumTodaySleep(){
    const todayKey = fmtDateKey(Date.now());
    let total = 0;
    for(const it of state.items){
      if(it.type==='sleep' && it.start && it.end){
        if(fmtDateKey(it.start) === todayKey) total += (it.end - it.start);
      }
    }
    if(sleepRunning && fmtDateKey(sleepRunning) === todayKey) total += (Date.now() - sleepRunning);
    return total;
  }
  function lastSleep(){
    for(const it of state.items){
      if(it.type==='sleep' && it.start && it.end) return it;
    }
    return null;
  }
  function lastFeedSession(){
    for(const it of state.items){
      if(it.type==='feed_session' && it.start && it.end) return it;
    }
    return null;
  }
  function countTodayFeedSessions(){
    const todayKey = fmtDateKey(Date.now());
    let c = 0;
    for(const it of state.items){
      if(it.type==='feed_session' && it.start && it.end){
        if(fmtDateKey(it.start) === todayKey) c++;
      }
    }
    if(feedSessionRunning && fmtDateKey(feedSessionRunning) === todayKey) c++;
    return c;
  }

  function timeSinceLast(type){
    // for feed/diaper instantaneous events return since last time
    for(const it of state.items){
      if(it.type === type && it.time) return Date.now() - it.time;
    }
    return null;
  }

  // render timeline grouped by day
  function groupByDay(items){
    const map = new Map();
    for(const it of items){
      const t = it.time ?? it.end ?? it.start;
      const key = fmtDateKey(t);
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(it);
    }
    return [...map.entries()].sort((a,b)=> b[0].localeCompare(a[0]));
  }

  function renderTimeline(){
    const frag = document.createDocumentFragment();
    if(state.items.length === 0 && !sleepRunning && !feedSessionRunning){
      const empty = document.createElement('div');
      empty.className = 'tiny';
      empty.style.margin = '6px 4px';
      empty.textContent = '–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –û—Ç–º–µ—Ç—å —Å–æ–Ω/–∫–æ—Ä–º–ª–µ–Ω–∏–µ/–ø–æ–¥–≥—É–∑–Ω–∏–∫.';
      frag.appendChild(empty);
      $timeline.replaceChildren(frag);
      return;
    }
    const entries = groupByDay(state.items);
    for(const [key, arr] of entries){
      const day = document.createElement('div'); day.className = 'day';
      const h = document.createElement('h3'); h.textContent = fmtDateHuman(new Date(key)); day.appendChild(h);
      // sort day items by newest first
      arr.sort((a,b)=> ( (b.time??b.end??b.start) - (a.time??a.end??a.start) ));
      for(const it of arr){
        const item = document.createElement('div'); item.className='item';
        const left = document.createElement('div'); left.className='left';
        const ico = document.createElement('div'); ico.className='ico';
        const meta = document.createElement('div'); meta.className='meta';
        const title = document.createElement('div'); title.className='title';
        const sub = document.createElement('div'); sub.className='sub';

        if(it.type === 'sleep'){
          ico.textContent = 'üò¥';
          const s = fmtTime(it.start), e = fmtTime(it.end);
          title.textContent = `–°–æ–Ω ${s} ‚Äî ${e}`;
          sub.textContent = fmtDuration(it.end - it.start);
        } else if(it.type === 'feed_session'){
          ico.textContent = 'üçΩ';
          const s = fmtTime(it.start), e = fmtTime(it.end);
          title.textContent = `–ü—Ä–æ–≥—É–ª–∫–∞ ${s} ‚Äî ${e}`;
          sub.textContent = fmtDuration(it.end - it.start);
        } else if(it.type === 'feed'){
          ico.textContent = 'üçº';
          title.textContent = '–ö–æ—Ä–º–ª–µ–Ω–∏–µ';
          sub.textContent = fmtTime(it.time);
        } else if(it.type === 'diaper'){
          ico.textContent = 'üß∑';
          title.textContent = '–ü–æ–¥–≥—É–∑–Ω–∏–∫';
          sub.textContent = fmtTime(it.time);
        }

        meta.appendChild(title);
        meta.appendChild(sub);
        left.appendChild(ico);
        left.appendChild(meta);

        const right = document.createElement('div'); right.className='right';
        const timeLabel = document.createElement('div'); timeLabel.className='tiny';
        timeLabel.textContent = (it.end ? fmtTime(it.end) : (it.time ? fmtTime(it.time) : '‚Äî'));
        const trash = document.createElement('button'); trash.className='trash';
        trash.innerHTML = '–£–¥–∞–ª–∏—Ç—å';
        trash.addEventListener('click', ()=> deleteItem(it.id));

        right.appendChild(timeLabel);
        right.appendChild(trash);

        item.appendChild(left);
        item.appendChild(right);
        day.appendChild(item);
      }
      frag.appendChild(day);
    }

    // show running sessions as top-most if exist
    if(sleepRunning){
      const live = document.createElement('div'); live.className='day';
      const h = document.createElement('h3'); h.textContent = '–¢–µ–∫—É—â–∏–µ'; live.appendChild(h);
      const item = document.createElement('div'); item.className='item';
      const left = document.createElement('div'); left.className='left';
      const ico = document.createElement('div'); ico.className='ico'; ico.textContent='üò¥';
      const meta = document.createElement('div'); meta.className='meta';
      const t1 = document.createElement('div'); t1.className='title'; t1.textContent = '–°–æ–Ω (–∏–¥—ë—Ç)';
      const t2 = document.createElement('div'); t2.className='sub'; t2.textContent = fmtDuration(Date.now() - sleepRunning);
      meta.appendChild(t1); meta.appendChild(t2);
      left.appendChild(ico); left.appendChild(meta);
      const right = document.createElement('div'); right.className='right';
      const stopBtn = document.createElement('button'); stopBtn.className='trash'; stopBtn.textContent='–°—Ç–æ–ø –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      stopBtn.addEventListener('click', stopSleep);
      right.appendChild(stopBtn);
      item.appendChild(left); item.appendChild(right);
      live.appendChild(item);
      frag.insertBefore(live, frag.firstChild);
    }

    if(feedSessionRunning){
      const live = document.createElement('div'); live.className='day';
      const h = document.createElement('h3'); h.textContent = '–¢–µ–∫—É—â–∏–µ'; live.appendChild(h);
      const item = document.createElement('div'); item.className='item';
      const left = document.createElement('div'); left.className='left';
      const ico = document.createElement('div'); ico.className='ico'; ico.textContent='üçΩ';
      const meta = document.createElement('div'); meta.className='meta';
      const t1 = document.createElement('div'); t1.className='title'; t1.textContent = '–ü—Ä–æ–≥—É–ª–∫–∞ (–∏–¥—ë—Ç)';
      const t2 = document.createElement('div'); t2.className='sub'; t2.textContent = fmtDuration(Date.now() - feedSessionRunning);
      meta.appendChild(t1); meta.appendChild(t2);
      left.appendChild(ico); left.appendChild(meta);
      const right = document.createElement('div'); right.className='right';
      const stopBtn = document.createElement('button'); stopBtn.className='trash'; stopBtn.textContent='–°—Ç–æ–ø –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      stopBtn.addEventListener('click', stopFeedSession);
      right.appendChild(stopBtn);
      item.appendChild(left); item.appendChild(right);
      live.appendChild(item);
      frag.insertBefore(live, frag.firstChild);
    }

    $timeline.replaceChildren(frag);
  }

  // update all UI parts
  function updateActiveUI(){
    // indicators
    $sleepIndicator.textContent = sleepRunning ? '–°–µ–π—á–∞—Å: —Å–ø–∏—Ç' : '–°–µ–π—á–∞—Å: –Ω–µ —Å–ø–∏—Ç';
    $feedSessIndicator.textContent = feedSessionRunning ? '–°–µ–π—á–∞—Å: –≤ –ø—Ä–æ–≥—É–ª–∫–∏' : '–°–µ–π—á–∞—Å: –¥–æ–º–∞';
    // KPIs
    $sleepToday.textContent = fmtDuration(sumTodaySleep());
    const last = lastSleep();
    $sleepLast.textContent = last ? fmtDuration(last.end - last.start) : '‚Äî';
    $sleepCurrent.textContent = sleepRunning ? fmtDuration(Date.now() - sleepRunning) : '‚Äî';

    $feedSessCount.textContent = countTodayFeedSessions();
    const lf = lastFeedSession();
    $feedSessLast.textContent = lf ? fmtDuration(lf.end - lf.start) : '‚Äî';
    $feedSessCurrent.textContent = feedSessionRunning ? fmtDuration(Date.now() - feedSessionRunning) : '‚Äî';

    // since last feed/diaper
    const sFeed = timeSinceLast('feed'); $sinceFeed.textContent = sFeed ? fmtDuration(sFeed) : '‚Äî';
    const sDiaper = timeSinceLast('diaper'); $sinceDiaper.textContent = sDiaper ? fmtDuration(sDiaper) : '‚Äî';
    $nowTime.textContent = new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});

    // update button styles for running sessions
    $sleepStart.disabled = !!sleepRunning;
    $sleepStop.disabled = !sleepRunning;
    $feedSessionStart.disabled = !!feedSessionRunning;
    $feedSessionStop.disabled = !feedSessionRunning;
  }

  // toast
  let toastTimer = null;
  function toast(msg, ms = 1500){
    $toast.textContent = msg;
    $toast.style.opacity = '1';
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> $toast.style.opacity = '0', ms);
  }

  // render wrapper
  function render(){
    renderTimeline();
    updateActiveUI();
  }

  // init
  function init(){
    load();
    render();

    // attach events
    $sleepStart.addEventListener('click', startSleep);
    $sleepStop.addEventListener('click', stopSleep);
    $feedSessionStart.addEventListener('click', startFeedSession);
    $feedSessionStop.addEventListener('click', stopFeedSession);

    $markFeed.addEventListener('click', ()=> addInstant('feed'));
    $markDiaper.addEventListener('click', ()=> addInstant('diaper'));

    $clearAll.addEventListener('click', (e)=>{
      e.preventDefault();
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏?')) return;
      state.items = [];
      sleepRunning = null; feedSessionRunning = null;
      save(); render(); toast('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
    });

    // tick to update running durations and "since last" every second
    tickTimer = setInterval(()=> {
      updateActiveUI();
      // we update timeline regularly too, but only every 2s to avoid redraw thrash
      if(Math.random() < 0.5) renderTimeline();
    }, 1000);
  }

  // expose stop functions for live items in timeline
  window.stopSleep = stopSleep;
  window.stopFeedSession = stopFeedSession;

  init();
})();
</script>
</body>
</html>
